import groovy.json.JsonSlurperClassic 
node(label:'dsp-jenkins-infra-validation') {
    cleanWs()
    def jenkinsRepo = "d_tool_central_jenkins"
    def infraRepo = "dsp_daa_fhir_layering"
    def robotFrameworkRepo = "root_framework" 
    def credentialId_mayur	= "0764162962-6467107276-0508748302"
    def credentialId_vumashan = "29571386410-29571386410-29571386410"
    def credentialId_dnethaji = "9e0a53bb-88d6-4697-b846-f1bcd55be9eb"
    def xrayUploader = "../${infraRepo}"
    def output = "Results"
    stage('Python Robot Framework Tests') {
        
                    if (params.UserName == "mayur"){
                        print "using credentials of user ${params.UserName}"
                        credential_id = "${credentialId_mayur}"
                        print "credential assigned"
                    }else if (params.UserName == "vumashan"){
                        print "using credentials of user ${params.UserName}"
                        credential_id = "${credentialId_vumashan}"
                    }else if (params.UserName == "dnethaji"){
                        print "using credentials of user ${params.UserName}"
                        credential_id = "${credentialId_dnethaji}"
                    }else{
                        print "INVALID USERNAME"
                        sh "exit 1"
                    }
                    // if (credential_id == "${credentialId_${params.UserName}"){
                    //     print "credential verified"
                    // }
                    dir (infraRepo){
                        git credentialsId: credential_id, branch:'Docspera_Automated_Test_D4C', url: "https://sourcecode.jnj.com/scm/asx-nayl/${infraRepo}.git"
                    }
                    dir (jenkinsRepo){
                        git credentialsId: credential_id, branch:'devops-coe', url: "https://sourcecode.jnj.com/scm/asx-nayl/${jenkinsRepo}.git"
                    }
                    sh (script:'lsb_release -a')
                    // sh ('sudo apt-get update -y')
                    //sh('sudo apt-get install -y firefox')
                    sh (script: 'sudo curl "https://bootstrap.pypa.io/pip/2.7/get-pip.py" -o "get-pip.py"')
                    sh (script: 'sudo python3.7 get-pip.py')
                    sh ('''
			sudo rm -R -f packages-microsoft*
                        wget -q https://packages.microsoft.com/config/ubuntu/16.04/packages-microsoft-prod.deb
                        sudo dpkg -i packages-microsoft-prod.deb
                        sudo apt-get update -y
                        sudo apt-get install -y powershell
                        ''')
                    sh (script:'pip install pdfkit')
                    // sh (script:'which wkhtmltopdf')
                    sh (script:"sudo apt-get -y install ./${jenkinsRepo}/resources/wkhtmltox_0.12.6-1.bionic_amd64.deb")
                    sh (script:'which wkhtmltopdf')
                    // sh (script: 'readlink -f geckodriver')
                    sh('sudo rm -f chromedriver*')
		            //sh('sudo rm -f geckodriver*')
                    sh (script:'sudo apt install -y chromium-browser')
                    sh (script:'sudo apt install unzip')
                    sh (script:'wget https://github.com/mozilla/geckodriver/releases/download/v0.27.0/geckodriver-v0.27.0-linux64.tar.gz')
                    sh (script:'wget https://chromedriver.storage.googleapis.com/${ChromeDriver}/chromedriver_linux64.zip')
                    sh (script:'unzip chromedriver_linux64.zip')
                    //sh (script:'tar -xvzf geckodriver*')
                    //sh (script:'chmod +x geckodriver')
                    sh (script:'chmod +x chromedriver')
                    //sh('sudo mv ./geckodriver  /usr/bin/')
                    sh('sudo mv ./chromedriver  /usr/bin/')
                    // sh('sudo ln -s /home/agentadmin/workspace/Team-DevOps/robotframwork_firefox/geckodriver  /usr/bin/geckodriver')
                    // sh('sudo mv /home/agentadmin/workspace/Team-DevOps/robotframwork_firefox/geckodriver  /usr/bin/geckodriver')
                    sh(script: 'pip install robotframework')
                    sh(script: 'pip install tabulate')
                    sh(script: 'pip install robotframework-seleniumlibrary')
                    sh(script: 'pip  install robotframework-selenium2library')
                    sh(script: 'pip install robotframework-extendedrequestslibrary')
					sh(script: 'pip install robotframework-requests-extension')
					sh(script: 'pip install PyMySQL')
					sh(script: 'pip install DBUtils')
                    sh(script: 'pip install cffi')
                    sh(script: 'pip install pprintpp')
                    sh(script: 'pip install azure-storage-blob --upgrade')
                    sh('pip install webdriver-manager')
                    //sh(script: 'firefox --version')
            //         dir(output){
            //         sh(script: "python3.7 -m robot.run -d ./ ../${infraRepo}/robot-framework/test-suites/05StorageAccount.robot")
            // }
                    dir(output){
                        def test_execution = sh(script: "python3.7 -m robot.run -v env:${env1} -v workDir:${env.WORKSPACE} -s JAYU-1062_Consume_Payload_From_LMI -d ./ ../dsp_daa_fhir_layering/robot-framework/test-suites", returnStatus: true)
                        sh "echo ${test_execution}"
                        if (test_execution != 0){
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                                // sh "exit 1"
                        }
					
                    }
			//def jsondata = readFile file: "api_output.txt"
                        //def lines = jsondata.readLines()
                       // str = generateHtml(lines)  
                       // writeFile file: "TestReport.html", text: "${str}"
			//sh('sudo rm api_output.txt')
				}
        
                //publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: pwd()+'/Results/', reportFiles: '*.html', //reportName: 'HTML Report', //reportTitles: ''])  
                
        }
        
		stage('Upload Output to Jira xray') {
        withCredentials([usernamePassword(credentialsId: credential_id, passwordVariable: 'pass', usernameVariable: 'uname')]) {
          sh(script:'pip install pdfkit bs4 jira python-dateutil tzlocal==2.1 jinja2 pyppeteer openpyxl lxml urllib3 pdfgen')
          dir (output){
            //sh(script: "python3.7 ${xrayUploader}/xray_uploader.py -r ./output.xml -u $uname -jprj JAYU -jurl https://jira.jnj.com -p $pass -a Add_Result -xtenv Dev -xex ${params.TestExecutionId}")
            sh(script: "python3.7 ${xrayUploader}/xray_uploader.py -r ./output.xml -u $uname -jprj JAYU -jurl https://jira.jnj.com -p $pass -a Add_Result -xtenv Dev -nu")
            
            }
       }
        // cleanWs()
    }

        //cleanWs()
}

@NonCPS
def generateHtml(def props) {

def writer = new StringWriter()  // html is written here by markup builder
def markup = new groovy.xml.MarkupBuilder(writer)  // the builder

// MAKE OF HTML
markup.html{
    markup.head{
    markup.style(type:"text/css", '''
    .header {
        color: white;
        margin: 30px;
        padding: 10px;
        background-color: #625eac
    }
      .row {
        margin: 30px;
        padding: 10px;
        background-color:  #b3f0ff
    }
    .nowrap{
    }
    ''')
  }
  for (def data in props) {
    markup.pre(class:"nowrap", data) 
    markup.br()
  }//foreach

}

return writer.toString()
  
}



